<!doctype html>
<html>
  <head>
    <title>Test Login NISN</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
      }
      .test-section {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .test-form {
        background: white;
        padding: 20px;
        border-radius: 8px;
      }
      input {
        padding: 10px;
        margin: 10px 0;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        padding: 10px 20px;
        background: #0b3d61;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      code {
        background: #f0f0f0;
        padding: 2px 6px;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Test Login NISN</h1>

    <div class="test-section">
      <h2>Step 1: Lihat Siswa yang Terdaftar</h2>
      <p>Periksa semua siswa yang sudah terdaftar di sistem:</p>
      <button onclick="loadStudents()">üìã Lihat Data Siswa</button>
      <div id="studentList"></div>
    </div>

    <div class="test-section">
      <h2>Step 2: Test Login</h2>
      <div class="test-form">
        <form onsubmit="testLogin(event)">
          <label><strong>NISN Siswa:</strong></label>
          <input
            type="text"
            id="nisn"
            placeholder="Contoh: 1234567890"
            required
          />

          <label><strong>Password:</strong></label>
          <input
            type="password"
            id="password"
            placeholder="Contoh: 1234567890"
            required
          />

          <button type="submit">üîì Test Login</button>
        </form>
        <div id="loginResult"></div>
      </div>
    </div>

    <script>
      function loadStudents() {
        fetch("debug-nisn.php")
          .then((r) => r.text())
          .then((html) => {
            document.getElementById("studentList").innerHTML = `
                        <div style="background: white; padding: 15px; border-radius: 4px; margin-top: 10px;">
                            <pre style="font-size: 12px; overflow-x: auto;">${html}</pre>
                        </div>
                    `;
          })
          .catch((e) => {
            document.getElementById("studentList").innerHTML = `
                        <div class="result error">‚ùå Error: ${e.message}</div>
                    `;
          });
      }

      function testLogin(e) {
        e.preventDefault();
        const nisn = document.getElementById("nisn").value;
        const password = document.getElementById("password").value;

        const formData = new FormData();
        formData.append("user_type", "student");
        formData.append("nisn", nisn);
        formData.append("password", password);

        fetch("public/api/login.php", {
          method: "POST",
          body: formData,
        })
          .then((r) => r.json())
          .then((data) => {
            const resultDiv = document.getElementById("loginResult");
            if (data.success) {
              resultDiv.innerHTML = `
                        <div class="result success">
                            <strong>‚úÖ Login Berhasil!</strong><br>
                            ${data.message}<br>
                            Redirect ke: ${data.redirect_url}
                        </div>
                    `;
            } else {
              resultDiv.innerHTML = `
                        <div class="result error">
                            <strong>‚ùå Login Gagal</strong><br>
                            ${data.message}<br>
                            <br>
                            <strong>Troubleshooting:</strong><br>
                            1. Pastikan NISN <code>${nisn}</code> ada di database<br>
                            2. Pastikan password sama dengan NISN (awal: <code>${nisn}</code>)<br>
                            3. Lihat browser console & error_log untuk detail<br>
                        </div>
                    `;
            }
          })
          .catch((e) => {
            document.getElementById("loginResult").innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Network Error</strong><br>
                        ${e.message}
                    </div>
                `;
          });
      }

      // Auto load students saat halaman dibuka
      document.addEventListener("DOMContentLoaded", loadStudents);
    </script>
  </body>
</html>
